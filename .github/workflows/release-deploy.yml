name: Deploy Databricks to UAT from JFrog (OIDC)

on:
  workflow_run:
    workflows: ["Build, Scan, and Upload to JFrog (Release â†’ UAT)"]
    types: [completed]

permissions:
  id-token: write
  contents: read

jobs:
  deploy-uat:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      DATABRICKS_TOKEN: ${{ secrets.UAT_DEPLOYMENT_TARGET_URL }}
      DATABRICKS_HOST: ${{ secrets.UAT_DEPLOYMENT_TARGET_TOKEN }}
      JF_URL: https://trialb2qcp1.jfrog.io

    steps:
      - uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          oidc-provider-name: edpypf/ADF-CICD@github
        env:
          JF_URL: ${{ env.JF_URL }}

      - name: Download latest artifact from JFrog
        run: |
          jfrog rt dl "adf_artifact_repo/databricks_bundle/release/*/databricks_bundle_build.zip" . --sort-by=created --limit=1 --flat
          unzip databricks_bundle_build.zip -d .

      - name: Set up Databricks CLI
        uses: databricks/setup-cli@main

      - name: Validate Databricks bundle
        run: databricks bundle validate --target uat

      - name: Deploy to UAT
        run: databricks bundle deploy --target uat
