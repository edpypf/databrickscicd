name: Databricks Unified CI/CD

on:
  push:
    branches:
      - main
      - release/*   # release branches trigger full pipeline
    paths-ignore:
      - .github/**
      - bundle_config/**

jobs:
  # ---------------------------------------------------
  # 1. Code Scan Job (optional, only for release/*)
  # ---------------------------------------------------
  code-scan:
    if: startsWith(github.ref, 'refs/heads/release/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run MSDO scanning
        uses: ./code-scan.yml

  # ---------------------------------------------------
  # 2. Build + Publish Artifacts (like ADO)
  # ---------------------------------------------------
  build:
    runs-on: ubuntu-latest
    needs: [code-scan]
    if: startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy files to artifact staging directory
        run: |
          mkdir -p artifact_staging
          rsync -av --exclude='archive/' --exclude='unit_test_results/' ./ artifact_staging/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: databricks_bundle_build
          path: artifact_staging/

  # ---------------------------------------------------
  # 3. Deploy to Dev automatically on every push to main
  # ---------------------------------------------------
  deploy-dev:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: development
    env:
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_DEV_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Databricks CLI
        uses: databricks/setup-cli@main

      - name: Validate Databricks Bundle (Dev)
        run: databricks bundle validate --target dev

      - name: Deploy to Databricks Dev
        run: databricks bundle deploy --target dev

  # ---------------------------------------------------
  # 4. Multi-environment Release Deploy (Dev → SIT → UAT → Prod)
  # ---------------------------------------------------
  deploy-matrix:
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/heads/release/')
    strategy:
      matrix:
        environment: [dev, sit, uat, prod]
    env:
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_HOST: ${{ matrix.environment == 'dev' && secrets.DATABRICKS_DEV_URL ||
                           matrix.environment == 'sit' && secrets.DATABRICKS_SIT_URL ||
                           matrix.environment == 'uat' && secrets.DATABRICKS_UAT_URL ||
                           secrets.DATABRICKS_PROD_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: databricks_bundle_build
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Databricks CLI
        uses: databricks/setup-cli@main

      - name: Validate Databricks Bundle
        run: databricks bundle validate --target ${{ matrix.environment }}

      - name: Deploy to Databricks
        run: databricks bundle deploy --target ${{ matrix.environment }}
