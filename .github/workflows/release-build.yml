name: Build, Scan, and Upload to JFrog (Release â†’ UAT)

on:
  push:
    branches:
      - release/*
    paths-ignore:
      - .github/**
      - bundle_config/**

permissions:
  id-token: write
  contents: read

jobs:
  code-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run MSDO Code Scan
        uses: ./.github/actions/code-scan

  build-and-upload:
    needs: code-scan
    runs-on: ubuntu-latest
    steps:
      - name: Package Databricks bundle
        run: |
          mkdir -p build_artifact
          ls -al
          rsync -av --exclude='archive/' --exclude='unit_test_results/' ./ build_artifact/
          ls -al build_artifact
          zip -r databricks_bundle_build.zip build_artifact

      # ðŸ§© Setup JFrog CLI with OIDC
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://trialb2qcp1.jfrog.io
        with:
          oidc-provider-name: edpypf/databrickscicd@github

      - name: Upload to JFrog
        run: |
          jfrog rt u "databricks_bundle_build.zip" \
            "adf_artifact_repo/databricks_bundle/release/${{ github.run_number }}/" --flat=true
